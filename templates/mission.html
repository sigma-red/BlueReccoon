<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLUE RECCOON // Mission</title>
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
    <nav class="top-nav">
        <div class="nav-left">
            <div class="nav-logo">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#0ea5e9" stroke-width="1.5"><circle cx="12" cy="12" r="10" opacity="0.4"/><circle cx="12" cy="12" r="3"/></svg>
                <a href="/" style="text-decoration:none;"><span class="nav-title">BLUE RECCOON</span></a>
            </div>
            <div class="nav-breadcrumb" id="missionBreadcrumb">Loading...</div>
        </div>
        <div class="nav-right">
            <div class="nav-operator"><span class="operator-dot"></span><span>{{ session.get('operator', 'Operator') }}</span></div>
            <a href="/logout" class="nav-btn-logout">Logout</a>
        </div>
    </nav>

    <main class="main-content">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <div>
                <h1 id="missionTitle" style="font-size:20px;font-weight:600;margin-bottom:4px;"></h1>
                <div style="display:flex;gap:12px;align-items:center;">
                    <span class="mission-type-badge" id="missionTypeBadge"></span>
                    <span class="classification-tag" id="missionClassTag"></span>
                    <span id="missionDesc" style="font-size:12px;color:var(--text-muted);max-width:500px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></span>
                </div>
            </div>
            <div style="display:flex;gap:8px;">
                <a id="topoLink" class="btn btn-primary" href="#">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="6" cy="6" r="3"/><circle cx="18" cy="18" r="3"/><circle cx="18" cy="6" r="3"/><line x1="8.5" y1="7.5" x2="15.5" y2="16.5"/></svg>
                    Network Topology
                </a>
                <a id="scanLink" class="btn btn-primary" href="#" style="background:linear-gradient(135deg, #10b981, #06b6d4);">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    Scan Control
                </a>
                <button class="btn btn-secondary" onclick="exportMission()">Export</button>
            </div>
        </div>

        <div class="stats-row" id="missionStats"></div>

        <div class="tab-bar" id="tabBar">
            <div class="tab-item active" data-tab="hosts">Hosts</div>
            <div class="tab-item" data-tab="ad">Active Directory</div>
            <div class="tab-item" data-tab="profiles">Host Profiles</div>
            <div class="tab-item" data-tab="subnets">Subnets</div>
            <div class="tab-item" data-tab="connections">Connections</div>
            <div class="tab-item" data-tab="intel">Threat Intel</div>
            <div class="tab-item" data-tab="hypotheses">Hunt Hypotheses</div>
        </div>

        <div id="tab-hosts" class="tab-panel"></div>
        <div id="tab-ad" class="tab-panel" style="display:none;"></div>
        <div id="tab-profiles" class="tab-panel" style="display:none;"></div>
        <div id="tab-subnets" class="tab-panel" style="display:none;"></div>
        <div id="tab-connections" class="tab-panel" style="display:none;"></div>
        <div id="tab-intel" class="tab-panel" style="display:none;"></div>
        <div id="tab-hypotheses" class="tab-panel" style="display:none;"></div>
    </main>

    <!-- Host Detail Modal -->
    <div class="modal-overlay" id="hostDetailModal" style="display:none;">
        <div class="modal" style="width:700px;max-height:85vh;overflow-y:auto;">
            <div class="modal-header">
                <h3 id="hostDetailTitle">Host Details</h3>
                <button class="modal-close" onclick="closeModal('hostDetailModal')">&times;</button>
            </div>
            <div class="modal-body" id="hostDetailBody"></div>
        </div>
    </div>

    <!-- Add Host Modal -->
    <div class="modal-overlay" id="addHostModal" style="display:none;">
        <div class="modal" style="width:500px;">
            <div class="modal-header">
                <h3>Add Host</h3>
                <button class="modal-close" onclick="closeModal('addHostModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">IP Address *</label>
                    <input type="text" class="form-input" id="newHostIp" placeholder="e.g., 10.0.1.50">
                </div>
                <div class="form-row" style="display:flex;gap:12px;">
                    <div class="form-group" style="flex:1;">
                        <label class="form-label">Hostname</label>
                        <input type="text" class="form-input" id="newHostHostname" placeholder="e.g., WORKSTATION-01">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label class="form-label">Domain</label>
                        <input type="text" class="form-input" id="newHostDomain" placeholder="e.g., corp.local">
                    </div>
                </div>
                <div class="form-row" style="display:flex;gap:12px;">
                    <div class="form-group" style="flex:1;">
                        <label class="form-label">Device Type</label>
                        <select class="form-input" id="newHostType">
                            <option value="unknown">Unknown</option>
                            <option value="workstation">Workstation</option>
                            <option value="server">Server</option>
                            <option value="dc">Domain Controller</option>
                            <option value="router">Router</option>
                            <option value="switch">Switch</option>
                            <option value="firewall">Firewall</option>
                            <option value="plc">PLC</option>
                            <option value="hmi">HMI</option>
                            <option value="rtu">RTU</option>
                            <option value="scada">SCADA</option>
                            <option value="printer">Printer</option>
                            <option value="iot">IoT Device</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label class="form-label">Criticality</label>
                        <select class="form-input" id="newHostCrit">
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" style="display:flex;gap:12px;">
                    <div class="form-group" style="flex:1;">
                        <label class="form-label">OS Name</label>
                        <input type="text" class="form-input" id="newHostOs" placeholder="e.g., Windows 10">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label class="form-label">Vendor</label>
                        <input type="text" class="form-input" id="newHostVendor" placeholder="e.g., Dell">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="newHostNotes" rows="2" style="resize:vertical;" placeholder="Optional notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addHostModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createHost()">Add Host</button>
            </div>
        </div>
    </div>

    <!-- Add Service Modal -->
    <div class="modal-overlay" id="addServiceModal" style="display:none;">
        <div class="modal" style="width:450px;">
            <div class="modal-header">
                <h3 id="addServiceTitle">Add Service</h3>
                <button class="modal-close" onclick="closeModal('addServiceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row" style="display:flex;gap:12px;">
                    <div class="form-group" style="flex:1;">
                        <label class="form-label">Port *</label>
                        <input type="number" class="form-input" id="newSvcPort" placeholder="e.g., 443" min="1" max="65535">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label class="form-label">Protocol</label>
                        <select class="form-input" id="newSvcProto">
                            <option value="tcp">TCP</option>
                            <option value="udp">UDP</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" style="display:flex;gap:12px;">
                    <div class="form-group" style="flex:1;">
                        <label class="form-label">Service Name</label>
                        <input type="text" class="form-input" id="newSvcName" placeholder="e.g., https">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label class="form-label">Version</label>
                        <input type="text" class="form-input" id="newSvcVersion" placeholder="e.g., Apache 2.4">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <input type="text" class="form-input" id="newSvcNotes" placeholder="Optional notes...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addServiceModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createService()">Add Service</button>
            </div>
        </div>
    </div>

    <script>
    const MISSION_ID = {{ mission_id }};
    let allHosts = [];
    let allSubnets = [];
    let allConnections = [];

    // ── Device type config ──
    const DEVICE_COLORS = {
        dc:'#f59e0b', server:'#0ea5e9', workstation:'#64748b', plc:'#ef4444',
        hmi:'#f97316', rtu:'#ec4899', scada:'#a855f7', firewall:'#10b981',
        router:'#06b6d4', switch:'#3b82f6', printer:'#6b7280', iot:'#8b5cf6', unknown:'#475569'
    };

    const DEVICE_LABELS = {
        dc:'Domain Controller', server:'Server', workstation:'Workstation', plc:'PLC',
        hmi:'HMI', rtu:'RTU', scada:'SCADA', firewall:'Firewall', router:'Router',
        switch:'Switch', printer:'Printer', iot:'IoT Device', unknown:'Unknown'
    };

    // ── Init ──
    async function init() {
        const mission = await fetchJSON(`/api/missions/${MISSION_ID}`);
        document.getElementById('missionTitle').textContent = mission.name;
        document.getElementById('missionBreadcrumb').textContent = mission.name;
        document.getElementById('missionDesc').textContent = mission.description || '';
        document.getElementById('topoLink').href = `/mission/${MISSION_ID}/topology`;
        document.getElementById('scanLink').href = `/mission/${MISSION_ID}/scans`;

        const typeBadge = document.getElementById('missionTypeBadge');
        typeBadge.textContent = mission.network_type;
        typeBadge.className = `mission-type-badge type-${mission.network_type.toLowerCase().replace('hybrid','hybrid')}`;

        document.getElementById('missionClassTag').textContent = mission.classification;

        await loadStats();
        await loadHosts();
        await loadAD();
        await loadProfiles();
        await loadSubnets();
        await loadConnections();
        await loadIntel();
        await loadHypotheses();
        initTabs();
    }

    // ── Tabs ──
    function initTabs() {
        document.querySelectorAll('.tab-item').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');
                tab.classList.add('active');
                document.getElementById(`tab-${tab.dataset.tab}`).style.display = 'block';
            });
        });
    }

    // ── Stats ──
    async function loadStats() {
        const stats = await fetchJSON(`/api/missions/${MISSION_ID}/stats`);
        const profileStats = stats.profile || {};
        const adStats = stats.ad || {};
        document.getElementById('missionStats').innerHTML = `
            <div class="stat-card"><div class="stat-value">${stats.hosts.total}</div><div class="stat-label">Hosts Discovered</div></div>
            <div class="stat-card"><div class="stat-value">${stats.hosts.alive}</div><div class="stat-label">Hosts Alive</div></div>
            <div class="stat-card"><div class="stat-value">${stats.services.total}</div><div class="stat-label">Open Services</div></div>
            <div class="stat-card"><div class="stat-value" style="color:var(--accent-red)">${stats.services.ot_protocols}</div><div class="stat-label">OT Protocols</div></div>
            <div class="stat-card"><div class="stat-value">${stats.subnets}</div><div class="stat-label">Subnets</div></div>
            <div class="stat-card"><div class="stat-value">${stats.connections}</div><div class="stat-label">Connections</div></div>
            ${adStats.domains ? `<div class="stat-card"><div class="stat-value" style="color:var(--accent-amber)">${adStats.domains}</div><div class="stat-label">AD Domains</div></div>` : ''}
            ${adStats.privileged_accounts ? `<div class="stat-card"><div class="stat-value" style="color:var(--accent-red)">${adStats.privileged_accounts}</div><div class="stat-label">Admin Accounts</div></div>` : ''}
            ${adStats.smb_shares ? `<div class="stat-card"><div class="stat-value">${adStats.smb_shares}</div><div class="stat-label">SMB Shares</div></div>` : ''}
            ${profileStats.hosts_profiled ? `<div class="stat-card"><div class="stat-value" style="color:var(--accent-green)">${profileStats.hosts_profiled}</div><div class="stat-label">Hosts Profiled</div></div>` : ''}
        `;
    }

    // ── Hosts ──
    async function loadHosts() {
        allHosts = await fetchJSON(`/api/missions/${MISSION_ID}/hosts`);
        const container = document.getElementById('tab-hosts');

        // Filter bar
        let html = `<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center;">
            <input type="text" class="form-input" style="max-width:250px;padding:6px 12px;font-size:12px;" placeholder="Filter hosts..." id="hostFilter" oninput="filterHosts()">
            <select class="form-input" style="max-width:150px;padding:6px 12px;font-size:12px;" id="typeFilter" onchange="filterHosts()">
                <option value="">All Types</option>
                ${[...new Set(allHosts.map(h=>h.device_type))].filter(Boolean).map(t=>`<option value="${t}">${DEVICE_LABELS[t]||t}</option>`).join('')}
            </select>
            <select class="form-input" style="max-width:150px;padding:6px 12px;font-size:12px;" id="critFilter" onchange="filterHosts()">
                <option value="">All Criticality</option>
                <option value="critical">Critical</option><option value="high">High</option>
                <option value="medium">Medium</option><option value="low">Low</option>
            </select>
            <select class="form-input" style="max-width:150px;padding:6px 12px;font-size:12px;" id="subnetFilter" onchange="filterHosts()">
                <option value="">All Subnets</option>
                ${[...new Set(allHosts.map(h=>h.subnet_cidr))].filter(Boolean).map(s=>`<option value="${s}">${s}</option>`).join('')}
            </select>
            <div style="margin-left:auto;">
                <button class="btn btn-primary" style="padding:6px 14px;font-size:12px;" onclick="showAddHostModal()">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                    Add Host
                </button>
            </div>
        </div>`;

        html += `<div class="panel"><div style="overflow-x:auto;"><table class="data-table"><thead><tr>
            <th>IP Address</th><th>Hostname</th><th>Type</th><th>OS</th><th>Subnet</th>
            <th>Services</th><th>Criticality</th><th>Vendor</th>
        </tr></thead><tbody id="hostsTableBody">`;

        html += renderHostRows(allHosts);
        html += `</tbody></table></div></div>`;
        container.innerHTML = html;
    }

    function renderHostRows(hosts) {
        return hosts.map(h => {
            const color = DEVICE_COLORS[h.device_type] || DEVICE_COLORS.unknown;
            const critClass = `crit-${h.criticality || 'medium'}`;
            return `<tr onclick="showHostDetail(${h.id})">
                <td style="color:var(--text-bright);font-weight:500;">${h.ip_address}</td>
                <td>${h.hostname || '<span style="color:var(--text-muted)">—</span>'}</td>
                <td><span class="device-icon" style="background:${color}"></span>${DEVICE_LABELS[h.device_type]||h.device_type||'Unknown'}</td>
                <td>${h.os_name ? `${h.os_name} ${h.os_version||''}` : '<span style="color:var(--text-muted)">—</span>'}</td>
                <td style="font-size:11px;">${h.subnet_cidr || '—'}</td>
                <td><span class="badge badge-blue">${h.service_count || 0}</span></td>
                <td><span class="crit-badge ${critClass}">${h.criticality || 'medium'}</span></td>
                <td style="font-size:11px;color:var(--text-muted);">${h.device_vendor || '—'}</td>
            </tr>`;
        }).join('');
    }

    function filterHosts() {
        const text = document.getElementById('hostFilter').value.toLowerCase();
        const type = document.getElementById('typeFilter').value;
        const crit = document.getElementById('critFilter').value;
        const subnet = document.getElementById('subnetFilter').value;

        const filtered = allHosts.filter(h => {
            if (text && !`${h.ip_address} ${h.hostname} ${h.os_name} ${h.device_vendor}`.toLowerCase().includes(text)) return false;
            if (type && h.device_type !== type) return false;
            if (crit && h.criticality !== crit) return false;
            if (subnet && h.subnet_cidr !== subnet) return false;
            return true;
        });
        document.getElementById('hostsTableBody').innerHTML = renderHostRows(filtered);
    }

    // ── Active Directory ──
    async function loadAD() {
        const domains = await fetchJSON(`/api/missions/${MISSION_ID}/domain_info`);
        const accounts = await fetchJSON(`/api/missions/${MISSION_ID}/privileged_accounts`);
        const container = document.getElementById('tab-ad');

        if (domains.length === 0 && accounts.length === 0) {
            container.innerHTML = '<div class="empty-state" style="padding:40px;">No Active Directory data collected yet. Run AD Enumeration or SMB Enumeration scans.</div>';
            return;
        }

        let html = '';

        // Domain Info
        domains.forEach(d => {
            const dcs = JSON.parse(d.domain_controllers || '[]');
            const trusts = JSON.parse(d.trusts || '[]');
            const ous = JSON.parse(d.ous || '[]');
            const gpos = JSON.parse(d.gpos || '[]');

            html += `<div class="panel" style="margin-bottom:16px;">
                <div style="padding:10px 14px;border-bottom:1px solid var(--border-primary);display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent-amber);text-transform:uppercase;letter-spacing:1px;">Domain: ${escapeHtml(d.domain_name)}</span>
                    ${d.functional_level ? `<span class="badge badge-blue">${escapeHtml(d.functional_level)}</span>` : ''}
                </div>
                <div style="padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div>
                        <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Domain Info</div>
                        ${detailRow('Domain Name', d.domain_name)}
                        ${detailRow('Forest Name', d.forest_name)}
                        ${detailRow('Functional Level', d.functional_level)}
                        ${detailRow('Discovered', d.discovered_at)}
                    </div>
                    <div>
                        <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Domain Controllers (${dcs.length})</div>
                        ${dcs.length > 0 ? dcs.map(dc => `<div style="font-size:12px;color:var(--text-bright);padding:2px 0;">${escapeHtml(typeof dc === 'string' ? dc : dc.name || JSON.stringify(dc))}</div>`).join('') : '<span style="color:var(--text-muted);font-size:12px;">None found</span>'}
                    </div>
                </div>`;

            // Trusts
            if (trusts.length > 0) {
                html += `<div style="padding:0 14px 14px;">
                    <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Trust Relationships (${trusts.length})</div>
                    <table class="data-table"><thead><tr><th>Trusted Domain</th><th>Direction</th></tr></thead><tbody>
                    ${trusts.map(t => `<tr>
                        <td style="color:var(--text-bright);font-size:12px;">${escapeHtml(typeof t === 'string' ? t : t.name || '')}</td>
                        <td style="font-size:12px;">${escapeHtml(typeof t === 'string' ? '' : t.direction || '')}</td>
                    </tr>`).join('')}
                    </tbody></table>
                </div>`;
            }

            // OUs
            if (ous.length > 0) {
                html += `<div style="padding:0 14px 14px;">
                    <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Organizational Units (${ous.length})</div>
                    <div style="display:flex;gap:6px;flex-wrap:wrap;">
                        ${ous.map(ou => `<span class="badge badge-blue" style="font-size:10px;">${escapeHtml(typeof ou === 'string' ? ou : ou.name || '')}</span>`).join('')}
                    </div>
                </div>`;
            }

            // GPOs
            if (gpos.length > 0) {
                html += `<div style="padding:0 14px 14px;">
                    <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Group Policy Objects (${gpos.length})</div>
                    <div style="display:flex;gap:6px;flex-wrap:wrap;">
                        ${gpos.map(g => `<span class="badge badge-blue" style="font-size:10px;">${escapeHtml(typeof g === 'string' ? g : g.name || '')}</span>`).join('')}
                    </div>
                </div>`;
            }

            html += `</div>`;
        });

        // Privileged Accounts
        if (accounts.length > 0) {
            const admins = accounts.filter(a => a.is_admin);
            const spnAccts = accounts.filter(a => a.spn);
            const otherAccts = accounts.filter(a => !a.is_admin && !a.spn);

            html += `<div class="panel" style="margin-bottom:16px;">
                <div style="padding:10px 14px;border-bottom:1px solid var(--border-primary);font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent-red);text-transform:uppercase;letter-spacing:1px;">
                    Privileged &amp; Notable Accounts (${accounts.length})
                </div>`;

            // Admin accounts
            if (admins.length > 0) {
                html += `<div style="padding:14px;">
                    <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent-red);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Admin Accounts (${admins.length})</div>
                    <table class="data-table"><thead><tr><th>Account</th><th>Type</th><th>Domain</th><th>Groups</th><th>Notes</th></tr></thead><tbody>
                    ${admins.map(a => {
                        const groups = JSON.parse(a.groups || '[]');
                        return `<tr>
                            <td style="color:var(--accent-red);font-weight:500;font-size:12px;">${escapeHtml(a.account_name)}</td>
                            <td style="font-size:11px;">${a.account_type || '—'}</td>
                            <td style="font-size:11px;color:var(--text-muted);">${a.domain || '—'}</td>
                            <td style="font-size:10px;">${groups.map(g => `<span class="badge badge-red" style="font-size:9px;">${escapeHtml(g)}</span>`).join(' ') || '—'}</td>
                            <td style="font-size:10px;color:var(--text-muted);">${a.notes || '—'}</td>
                        </tr>`;
                    }).join('')}
                    </tbody></table>
                </div>`;
            }

            // SPN / Kerberoastable accounts
            if (spnAccts.length > 0) {
                html += `<div style="padding:0 14px 14px;">
                    <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent-amber);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Kerberoastable Accounts — SPN (${spnAccts.length})</div>
                    <table class="data-table"><thead><tr><th>Account</th><th>Domain</th><th>SPN</th><th>Notes</th></tr></thead><tbody>
                    ${spnAccts.map(a => `<tr>
                        <td style="color:var(--accent-amber);font-weight:500;font-size:12px;">${escapeHtml(a.account_name)}</td>
                        <td style="font-size:11px;color:var(--text-muted);">${a.domain || '—'}</td>
                        <td style="font-size:10px;font-family:'JetBrains Mono',monospace;">${escapeHtml(a.spn || '—')}</td>
                        <td style="font-size:10px;color:var(--text-muted);">${a.notes || '—'}</td>
                    </tr>`).join('')}
                    </tbody></table>
                </div>`;
            }

            // Other enumerated accounts
            if (otherAccts.length > 0) {
                html += `<div style="padding:0 14px 14px;">
                    <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Enumerated Accounts (${otherAccts.length})</div>
                    <div style="max-height:250px;overflow-y:auto;">
                    <table class="data-table"><thead><tr><th>Account</th><th>Type</th><th>Domain</th><th>Notes</th></tr></thead><tbody>
                    ${otherAccts.map(a => `<tr>
                        <td style="color:var(--text-bright);font-size:12px;">${escapeHtml(a.account_name)}</td>
                        <td style="font-size:11px;">${a.account_type || '—'}</td>
                        <td style="font-size:11px;color:var(--text-muted);">${a.domain || '—'}</td>
                        <td style="font-size:10px;color:var(--text-muted);">${a.notes || '—'}</td>
                    </tr>`).join('')}
                    </tbody></table>
                    </div>
                </div>`;
            }

            html += `</div>`;
        }

        container.innerHTML = html;
    }

    // ── Host Profiles ──
    let profiledHosts = [];
    let expandedProfileHost = null;

    async function loadProfiles() {
        profiledHosts = await fetchJSON(`/api/missions/${MISSION_ID}/host_profiles`);
        const container = document.getElementById('tab-profiles');

        if (profiledHosts.length === 0) {
            container.innerHTML = '<div class="empty-state" style="padding:40px;">No hosts profiled yet. Run the Host Profiling scan to collect software, processes, services, tasks, and group data.</div>';
            return;
        }

        // Summary stats
        const totals = profiledHosts.reduce((acc, h) => ({
            software: acc.software + (h.software_count || 0),
            processes: acc.processes + (h.process_count || 0),
            services: acc.services + (h.service_count || 0),
            tasks: acc.tasks + (h.task_count || 0),
            groups: acc.groups + (h.group_count || 0),
            shares: acc.shares + (h.smb_share_count || 0)
        }), {software:0, processes:0, services:0, tasks:0, groups:0, shares:0});

        let html = `<div class="stats-row" style="margin-bottom:16px;">
            <div class="stat-card"><div class="stat-value" style="color:var(--accent-green)">${profiledHosts.length}</div><div class="stat-label">Hosts Profiled</div></div>
            <div class="stat-card"><div class="stat-value">${totals.software}</div><div class="stat-label">Software Entries</div></div>
            <div class="stat-card"><div class="stat-value">${totals.processes}</div><div class="stat-label">Processes</div></div>
            <div class="stat-card"><div class="stat-value">${totals.services}</div><div class="stat-label">System Services</div></div>
            <div class="stat-card"><div class="stat-value">${totals.tasks}</div><div class="stat-label">Scheduled Tasks</div></div>
            <div class="stat-card"><div class="stat-value">${totals.groups}</div><div class="stat-label">Local Groups</div></div>
            ${totals.shares ? `<div class="stat-card"><div class="stat-value">${totals.shares}</div><div class="stat-label">SMB Shares</div></div>` : ''}
        </div>`;

        // Filter
        html += `<div style="margin-bottom:12px;">
            <input type="text" class="form-input" style="max-width:300px;padding:6px 12px;font-size:12px;" placeholder="Filter profiled hosts..." id="profileFilter" oninput="filterProfiles()">
        </div>`;

        // Host table
        html += `<div class="panel"><div style="overflow-x:auto;"><table class="data-table"><thead><tr>
            <th></th><th>IP Address</th><th>Hostname</th><th>OS</th><th>Software</th>
            <th>Processes</th><th>Services</th><th>Tasks</th><th>Groups</th>
        </tr></thead><tbody id="profilesTableBody">`;
        html += renderProfileRows(profiledHosts);
        html += `</tbody></table></div></div>`;

        // Expanded detail container
        html += `<div id="profileDetailContainer"></div>`;

        container.innerHTML = html;
    }

    function renderProfileRows(hosts) {
        return hosts.map(h => {
            const color = DEVICE_COLORS[h.device_type] || DEVICE_COLORS.unknown;
            const isExpanded = expandedProfileHost === h.id;
            return `<tr onclick="toggleProfileDetail(${h.id})" style="cursor:pointer;${isExpanded ? 'background:rgba(14,165,233,0.08);' : ''}">
                <td style="width:20px;color:var(--accent-cyan);font-size:10px;">${isExpanded ? '&#9660;' : '&#9654;'}</td>
                <td style="color:var(--text-bright);font-weight:500;">${h.ip_address}</td>
                <td>${h.hostname || '<span style="color:var(--text-muted)">—</span>'}</td>
                <td style="font-size:11px;">${h.os_name ? `${h.os_name} ${h.os_version||''}` : '—'}</td>
                <td><span class="badge badge-blue">${h.software_count || 0}</span></td>
                <td><span class="badge badge-blue">${h.process_count || 0}</span></td>
                <td><span class="badge badge-blue">${h.service_count || 0}</span></td>
                <td><span class="badge badge-blue">${h.task_count || 0}</span></td>
                <td><span class="badge badge-blue">${h.group_count || 0}</span></td>
            </tr>`;
        }).join('');
    }

    function filterProfiles() {
        const text = document.getElementById('profileFilter').value.toLowerCase();
        const filtered = profiledHosts.filter(h => {
            return `${h.ip_address} ${h.hostname} ${h.os_name}`.toLowerCase().includes(text);
        });
        document.getElementById('profilesTableBody').innerHTML = renderProfileRows(filtered);
    }

    async function toggleProfileDetail(hostId) {
        const container = document.getElementById('profileDetailContainer');
        if (expandedProfileHost === hostId) {
            expandedProfileHost = null;
            container.innerHTML = '';
            document.getElementById('profilesTableBody').innerHTML = renderProfileRows(profiledHosts);
            return;
        }

        expandedProfileHost = hostId;
        document.getElementById('profilesTableBody').innerHTML = renderProfileRows(profiledHosts);
        container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);">Loading profile data...</div>';

        const data = await fetchJSON(`/api/hosts/${hostId}`);
        const h = data.host;

        let html = `<div class="panel" style="margin-top:16px;border-color:rgba(14,165,233,0.3);">
            <div style="padding:10px 14px;border-bottom:1px solid var(--border-primary);display:flex;justify-content:space-between;align-items:center;">
                <span style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent-cyan);font-weight:600;">
                    ${escapeHtml(h.hostname || h.ip_address)} ${h.os_name ? `— ${escapeHtml(h.os_name)} ${h.os_version||''}` : ''}
                </span>
                <button class="btn btn-secondary" style="padding:3px 10px;font-size:10px;" onclick="toggleProfileDetail(${hostId})">Close</button>
            </div>`;

        // Sub-tab bar for profile sections
        const sections = [];
        if (data.software && data.software.length) sections.push({id:'sw', label:`Software (${data.software.length})`});
        if (data.processes && data.processes.length) sections.push({id:'proc', label:`Processes (${data.processes.length})`});
        if (data.host_services && data.host_services.length) sections.push({id:'svc', label:`Services (${data.host_services.length})`});
        if (data.scheduled_tasks && data.scheduled_tasks.length) sections.push({id:'task', label:`Tasks (${data.scheduled_tasks.length})`});
        if (data.local_groups && data.local_groups.length) sections.push({id:'grp', label:`Groups (${data.local_groups.length})`});
        if (data.smb_shares && data.smb_shares.length) sections.push({id:'smb', label:`SMB Shares (${data.smb_shares.length})`});

        if (sections.length === 0) {
            html += '<div style="padding:20px;text-align:center;color:var(--text-muted);">No profile data collected for this host.</div></div>';
            container.innerHTML = html;
            return;
        }

        html += `<div style="display:flex;gap:0;border-bottom:1px solid var(--border-primary);">`;
        sections.forEach((s, i) => {
            html += `<div class="profile-sub-tab${i===0?' profile-sub-tab-active':''}" data-section="${s.id}" onclick="switchProfileSection('${s.id}', this)"
                style="padding:8px 14px;font-size:11px;font-family:'JetBrains Mono',monospace;cursor:pointer;color:${i===0?'var(--accent-cyan)':'var(--text-muted)'};border-bottom:2px solid ${i===0?'var(--accent-cyan)':'transparent'};transition:all 0.15s;"
                onmouseenter="if(!this.classList.contains('profile-sub-tab-active'))this.style.color='var(--text-primary)'"
                onmouseleave="if(!this.classList.contains('profile-sub-tab-active'))this.style.color='var(--text-muted)'"
                >${s.label}</div>`;
        });
        html += `</div>`;

        // Software section
        if (data.software && data.software.length) {
            html += `<div class="profile-section" id="profile-sec-sw" style="display:block;">
                <div style="padding:8px 14px;display:flex;gap:8px;align-items:center;">
                    <input type="text" class="form-input" style="max-width:250px;padding:4px 10px;font-size:11px;" placeholder="Search software..." oninput="filterProfileTable(this, 'profile-sw-tbody')">
                </div>
                <div style="max-height:400px;overflow-y:auto;">
                <table class="data-table"><thead><tr><th>Name</th><th>Version</th><th>Publisher</th><th>Install Date</th><th>Source</th><th>Arch</th></tr></thead>
                <tbody id="profile-sw-tbody">
                ${data.software.map(s => `<tr>
                    <td style="color:var(--text-bright);font-size:11px;">${escapeHtml(s.name)}</td>
                    <td style="font-size:11px;">${s.version || '—'}</td>
                    <td style="font-size:11px;color:var(--text-muted);">${s.publisher || '—'}</td>
                    <td style="font-size:10px;color:var(--text-muted);">${s.install_date || '—'}</td>
                    <td><span class="badge badge-blue" style="font-size:9px;">${s.install_source || '—'}</span></td>
                    <td style="font-size:10px;color:var(--text-muted);">${s.architecture || '—'}</td>
                </tr>`).join('')}
                </tbody></table>
                </div>
            </div>`;
        }

        // Processes section
        if (data.processes && data.processes.length) {
            html += `<div class="profile-section" id="profile-sec-proc" style="display:none;">
                <div style="padding:8px 14px;display:flex;gap:8px;align-items:center;">
                    <input type="text" class="form-input" style="max-width:250px;padding:4px 10px;font-size:11px;" placeholder="Search processes..." oninput="filterProfileTable(this, 'profile-proc-tbody')">
                </div>
                <div style="max-height:400px;overflow-y:auto;">
                <table class="data-table"><thead><tr><th>PID</th><th>Name</th><th>User</th><th>Memory</th><th>Command Line</th></tr></thead>
                <tbody id="profile-proc-tbody">
                ${data.processes.map(p => `<tr>
                    <td style="color:var(--accent-cyan);font-size:11px;">${p.pid != null ? p.pid : '—'}</td>
                    <td style="color:var(--text-bright);font-size:11px;">${escapeHtml(p.name)}</td>
                    <td style="font-size:11px;color:var(--text-muted);">${p.username || '—'}</td>
                    <td style="font-size:11px;">${p.memory_bytes ? formatBytes(p.memory_bytes) : '—'}</td>
                    <td style="font-size:10px;color:var(--text-muted);max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtml(p.command_line||'')}">${escapeHtml(p.command_line || '—')}</td>
                </tr>`).join('')}
                </tbody></table>
                </div>
            </div>`;
        }

        // System Services section
        if (data.host_services && data.host_services.length) {
            html += `<div class="profile-section" id="profile-sec-svc" style="display:none;">
                <div style="padding:8px 14px;display:flex;gap:8px;align-items:center;">
                    <input type="text" class="form-input" style="max-width:250px;padding:4px 10px;font-size:11px;" placeholder="Search services..." oninput="filterProfileTable(this, 'profile-svc-tbody')">
                </div>
                <div style="max-height:400px;overflow-y:auto;">
                <table class="data-table"><thead><tr><th>Service</th><th>Display Name</th><th>State</th><th>Start Type</th><th>Run As</th><th>Path</th></tr></thead>
                <tbody id="profile-svc-tbody">
                ${data.host_services.map(s => {
                    const stateColor = s.service_state === 'running' ? 'var(--accent-green)' : (s.service_state === 'stopped' || s.service_state === 'dead') ? 'var(--accent-red)' : 'var(--text-muted)';
                    return `<tr>
                        <td style="color:var(--text-bright);font-size:11px;">${escapeHtml(s.service_name || s.name)}</td>
                        <td style="font-size:11px;">${s.service_display_name || '—'}</td>
                        <td><span style="color:${stateColor};font-size:11px;font-weight:500;">${s.service_state || '—'}</span></td>
                        <td style="font-size:11px;color:var(--text-muted);">${s.start_type || '—'}</td>
                        <td style="font-size:11px;color:var(--text-muted);">${s.username || '—'}</td>
                        <td style="font-size:10px;color:var(--text-muted);max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtml(s.exe_path||'')}">${escapeHtml(s.exe_path || '—')}</td>
                    </tr>`;
                }).join('')}
                </tbody></table>
                </div>
            </div>`;
        }

        // Scheduled Tasks section
        if (data.scheduled_tasks && data.scheduled_tasks.length) {
            html += `<div class="profile-section" id="profile-sec-task" style="display:none;">
                <div style="padding:8px 14px;display:flex;gap:8px;align-items:center;">
                    <input type="text" class="form-input" style="max-width:250px;padding:4px 10px;font-size:11px;" placeholder="Search tasks..." oninput="filterProfileTable(this, 'profile-task-tbody')">
                </div>
                <div style="max-height:400px;overflow-y:auto;">
                <table class="data-table"><thead><tr><th>Name</th><th>Status</th><th>Command</th><th>Run As</th><th>Schedule</th><th>Last Run</th><th>Source</th></tr></thead>
                <tbody id="profile-task-tbody">
                ${data.scheduled_tasks.map(t => `<tr>
                    <td style="color:var(--text-bright);font-size:11px;">${escapeHtml(t.task_name)}</td>
                    <td style="font-size:11px;">${t.status || '—'}</td>
                    <td style="font-size:10px;color:var(--text-muted);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtml(t.command||'')}">${escapeHtml(t.command || '—')}</td>
                    <td style="font-size:11px;color:var(--text-muted);">${t.run_as_user || '—'}</td>
                    <td style="font-size:10px;color:var(--text-muted);">${t.trigger_info || '—'}</td>
                    <td style="font-size:10px;color:var(--text-muted);">${t.last_run || '—'}</td>
                    <td><span class="badge badge-blue" style="font-size:9px;">${t.source || '—'}</span></td>
                </tr>`).join('')}
                </tbody></table>
                </div>
            </div>`;
        }

        // Local Groups section
        if (data.local_groups && data.local_groups.length) {
            html += `<div class="profile-section" id="profile-sec-grp" style="display:none;">
                <div style="max-height:400px;overflow-y:auto;">
                <table class="data-table"><thead><tr><th>Group</th><th>Type</th><th>Members</th><th>Description</th></tr></thead>
                <tbody>
                ${data.local_groups.map(g => {
                    const members = JSON.parse(g.members || '[]');
                    const privBadge = g.is_privileged ? ' <span class="badge badge-red" style="font-size:8px;">PRIVILEGED</span>' : '';
                    return `<tr>
                        <td style="color:var(--text-bright);font-size:11px;">${escapeHtml(g.group_name)}${privBadge}</td>
                        <td style="font-size:11px;color:var(--text-muted);">${g.group_type || 'local'}</td>
                        <td style="font-size:10px;color:var(--text-secondary);">${members.length > 0 ? members.map(m => escapeHtml(m)).join(', ') : '<span style="color:var(--text-muted)">—</span>'}</td>
                        <td style="font-size:10px;color:var(--text-muted);">${g.description || '—'}</td>
                    </tr>`;
                }).join('')}
                </tbody></table>
                </div>
            </div>`;
        }

        // SMB Shares section
        if (data.smb_shares && data.smb_shares.length) {
            html += `<div class="profile-section" id="profile-sec-smb" style="display:none;">
                <table class="data-table"><thead><tr><th>Share Name</th><th>Type</th><th>Comment</th></tr></thead>
                <tbody>
                ${data.smb_shares.map(s => {
                    const typeColor = s.share_type === 'Disk' ? 'var(--accent-cyan)' : s.share_type === 'IPC' ? 'var(--accent-amber)' : 'var(--text-muted)';
                    return `<tr>
                        <td style="color:var(--text-bright);font-weight:500;font-size:12px;">${escapeHtml(s.share_name)}</td>
                        <td><span style="color:${typeColor};font-size:11px;">${s.share_type || '—'}</span></td>
                        <td style="font-size:11px;color:var(--text-muted);">${s.comment || '—'}</td>
                    </tr>`;
                }).join('')}
                </tbody></table>
            </div>`;
        }

        html += `</div>`;
        container.innerHTML = html;
    }

    function switchProfileSection(sectionId, el) {
        // Hide all sections, show selected
        document.querySelectorAll('.profile-section').forEach(s => s.style.display = 'none');
        const target = document.getElementById(`profile-sec-${sectionId}`);
        if (target) target.style.display = 'block';

        // Update sub-tab styles
        document.querySelectorAll('.profile-sub-tab').forEach(t => {
            t.classList.remove('profile-sub-tab-active');
            t.style.color = 'var(--text-muted)';
            t.style.borderBottom = '2px solid transparent';
        });
        el.classList.add('profile-sub-tab-active');
        el.style.color = 'var(--accent-cyan)';
        el.style.borderBottom = '2px solid var(--accent-cyan)';
    }

    function filterProfileTable(input, tbodyId) {
        const text = input.value.toLowerCase();
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;
        Array.from(tbody.rows).forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(text) ? '' : 'none';
        });
    }

    // ── Host Detail ──
    let currentHostId = null;

    async function showHostDetail(hostId) {
        currentHostId = hostId;
        const data = await fetchJSON(`/api/hosts/${hostId}`);
        const h = data.host;
        const color = DEVICE_COLORS[h.device_type] || DEVICE_COLORS.unknown;

        document.getElementById('hostDetailTitle').innerHTML = `
            <span class="device-icon" style="background:${color};width:10px;height:10px;"></span>
            ${h.hostname || h.ip_address}`;

        const typeOptions = Object.entries(DEVICE_LABELS).map(([k,v]) =>
            `<option value="${k}" ${h.device_type===k?'selected':''}>${v}</option>`).join('');
        const critOptions = ['critical','high','medium','low'].map(c =>
            `<option value="${c}" ${h.criticality===c?'selected':''}>${c}</option>`).join('');

        let html = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
            <div class="panel" style="padding:14px;">
                <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">Network Info</div>
                ${detailRow('IP Address', h.ip_address)}
                ${editableRow('MAC Address', 'mac_address', h.mac_address, hostId)}
                ${editableRow('Hostname', 'hostname', h.hostname, hostId)}
                ${editableRow('Domain', 'domain', h.domain, hostId)}
                ${detailRow('Subnet', h.subnet_id)}
            </div>
            <div class="panel" style="padding:14px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;">Device Info</div>
                    <span style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent-cyan);opacity:0.6;">CLICK VALUES TO EDIT</span>
                </div>
                ${editableRow('OS Name', 'os_name', h.os_name, hostId)}
                ${editableRow('OS Version', 'os_version', h.os_version, hostId)}
                ${editableSelectRow('Type', 'device_type', typeOptions, hostId)}
                ${editableRow('Vendor', 'device_vendor', h.device_vendor, hostId)}
                ${editableRow('Model', 'device_model', h.device_model, hostId)}
                ${editableRow('Firmware', 'firmware_version', h.firmware_version, hostId)}
                ${editableSelectRow('Criticality', 'criticality', critOptions, hostId)}
            </div>
        </div>`;

        // Host Notes
        html += `<div class="panel" style="margin-bottom:16px;">
            <div style="padding:10px 14px;border-bottom:1px solid var(--border-primary);font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;">
                Host Notes
            </div>
            <div style="padding:10px 14px;">
                <textarea id="hostNotesArea" rows="3" placeholder="Add notes about this host..."
                    style="width:100%;background:var(--bg-primary);color:var(--text-primary);border:1px solid var(--border-primary);border-radius:4px;padding:8px 10px;font-size:12px;font-family:'JetBrains Mono',monospace;resize:vertical;outline:none;box-sizing:border-box;"
                    onfocus="this.style.borderColor='var(--accent-cyan)'"
                    onblur="this.style.borderColor='var(--border-primary)'; saveHostNotes(${hostId})">${h.notes ? escapeHtml(h.notes) : ''}</textarea>
            </div>
        </div>`;

        // Services
        // Services section (always show - allow adding even if none exist)
        {
            html += `<div class="panel" style="margin-bottom:16px;">
                <div style="padding:10px 14px;border-bottom:1px solid var(--border-primary);display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;">Open Services (${data.services.length})</span>
                    <button class="btn btn-secondary" style="padding:3px 10px;font-size:10px;" onclick="showAddServiceModal(${hostId})">+ Add Service</button>
                </div>
                <table class="data-table"><thead><tr><th>Port</th><th>Proto</th><th>Service</th><th>Version</th><th>OT</th><th>Notes</th></tr></thead><tbody>
                ${data.services.map(s => `<tr>
                    <td style="color:var(--accent-cyan);font-weight:500;">${s.port}</td>
                    <td>${s.protocol}</td>
                    <td>${s.service_name || '—'}</td>
                    <td style="font-size:11px;">${s.service_version || '—'}</td>
                    <td>${s.is_ot_protocol ? `<span class="badge badge-red">${s.ot_protocol_name}</span>` : ''}</td>
                    <td class="svc-note-cell" data-service-id="${s.id}" onclick="editServiceNote(this, ${s.id})" style="font-size:11px;color:var(--text-secondary);cursor:pointer;min-width:120px;" title="Click to add/edit note">${s.notes ? escapeHtml(s.notes) : '<span style="color:var(--text-muted);font-style:italic;font-size:10px;">+ add note</span>'}</td>
                </tr>`).join('')}
                </tbody></table>
            </div>`;
        }

        // OT Device Info
        if (data.ot_device) {
            const o = data.ot_device;
            html += `<div class="panel" style="margin-bottom:16px;border-color:rgba(239,68,68,0.3);">
                <div style="padding:10px 14px;border-bottom:1px solid rgba(239,68,68,0.2);font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent-red);text-transform:uppercase;letter-spacing:1px;">
                    OT Device Details
                </div>
                <div style="padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    ${detailRow('Device Class', o.device_class)}
                    ${detailRow('Vendor', o.vendor)}
                    ${detailRow('Model', o.model)}
                    ${detailRow('Firmware', o.firmware)}
                    ${detailRow('Serial', o.serial_number)}
                    ${detailRow('Protocol', o.protocol)}
                    ${detailRow('Role', o.master_slave_role)}
                </div>
            </div>`;
        }

        // SMB Shares
        if (data.smb_shares && data.smb_shares.length > 0) {
            html += `<div class="panel" style="margin-bottom:16px;">
                <div style="padding:10px 14px;border-bottom:1px solid var(--border-primary);font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;">
                    SMB Shares (${data.smb_shares.length})
                </div>
                <table class="data-table"><thead><tr><th>Share Name</th><th>Type</th><th>Comment</th></tr></thead><tbody>
                ${data.smb_shares.map(s => {
                    const typeColor = s.share_type === 'Disk' ? 'var(--accent-cyan)' : s.share_type === 'IPC' ? 'var(--accent-amber)' : 'var(--text-muted)';
                    return `<tr>
                        <td style="color:var(--text-bright);font-weight:500;font-size:12px;">${escapeHtml(s.share_name)}</td>
                        <td><span style="color:${typeColor};font-size:11px;">${s.share_type || '—'}</span></td>
                        <td style="font-size:11px;color:var(--text-muted);">${s.comment || '—'}</td>
                    </tr>`;
                }).join('')}
                </tbody></table>
            </div>`;
        }

        // Installed Software
        if (data.software && data.software.length > 0) {
            html += `<div class="panel" style="margin-bottom:16px;">
                <div style="padding:10px 14px;border-bottom:1px solid var(--border-primary);font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;">
                    Installed Software (${data.software.length})
                </div>
                <div style="max-height:250px;overflow-y:auto;">
                <table class="data-table"><thead><tr><th>Name</th><th>Version</th><th>Publisher</th><th>Source</th></tr></thead><tbody>
                ${data.software.map(s => `<tr>
                    <td style="color:var(--text-bright);font-size:11px;">${s.name}</td>
                    <td style="font-size:11px;">${s.version || '—'}</td>
                    <td style="font-size:11px;color:var(--text-muted);">${s.publisher || '—'}</td>
                    <td><span class="badge badge-blue" style="font-size:9px;">${s.install_source || '—'}</span></td>
                </tr>`).join('')}
                </tbody></table>
                </div>
            </div>`;
        }

        // Running Processes
        if (data.processes && data.processes.length > 0) {
            html += `<div class="panel" style="margin-bottom:16px;">
                <div style="padding:10px 14px;border-bottom:1px solid var(--border-primary);font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;">
                    Running Processes (${data.processes.length})
                </div>
                <div style="max-height:250px;overflow-y:auto;">
                <table class="data-table"><thead><tr><th>PID</th><th>Name</th><th>User</th><th>Memory</th></tr></thead><tbody>
                ${data.processes.map(p => `<tr>
                    <td style="color:var(--accent-cyan);font-size:11px;">${p.pid || '—'}</td>
                    <td style="color:var(--text-bright);font-size:11px;">${p.name}</td>
                    <td style="font-size:11px;color:var(--text-muted);">${p.username || '—'}</td>
                    <td style="font-size:11px;">${p.memory_bytes ? formatBytes(p.memory_bytes) : '—'}</td>
                </tr>`).join('')}
                </tbody></table>
                </div>
            </div>`;
        }

        // Host Services (Windows services / systemd units)
        if (data.host_services && data.host_services.length > 0) {
            html += `<div class="panel" style="margin-bottom:16px;">
                <div style="padding:10px 14px;border-bottom:1px solid var(--border-primary);font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;">
                    System Services (${data.host_services.length})
                </div>
                <div style="max-height:250px;overflow-y:auto;">
                <table class="data-table"><thead><tr><th>Service</th><th>Display Name</th><th>State</th><th>Start</th><th>User</th></tr></thead><tbody>
                ${data.host_services.map(s => {
                    const stateColor = s.service_state === 'running' ? 'var(--accent-green)' : s.service_state === 'stopped' || s.service_state === 'dead' ? 'var(--accent-red)' : 'var(--text-muted)';
                    return `<tr>
                        <td style="color:var(--text-bright);font-size:11px;">${s.service_name || s.name}</td>
                        <td style="font-size:11px;">${s.service_display_name || '—'}</td>
                        <td><span style="color:${stateColor};font-size:11px;font-weight:500;">${s.service_state || '—'}</span></td>
                        <td style="font-size:11px;color:var(--text-muted);">${s.start_type || '—'}</td>
                        <td style="font-size:11px;color:var(--text-muted);">${s.username || '—'}</td>
                    </tr>`;
                }).join('')}
                </tbody></table>
                </div>
            </div>`;
        }

        // Scheduled Tasks
        if (data.scheduled_tasks && data.scheduled_tasks.length > 0) {
            html += `<div class="panel" style="margin-bottom:16px;">
                <div style="padding:10px 14px;border-bottom:1px solid var(--border-primary);font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;">
                    Scheduled Tasks (${data.scheduled_tasks.length})
                </div>
                <div style="max-height:250px;overflow-y:auto;">
                <table class="data-table"><thead><tr><th>Name</th><th>Command</th><th>Run As</th><th>Status</th><th>Source</th></tr></thead><tbody>
                ${data.scheduled_tasks.map(t => `<tr>
                    <td style="color:var(--text-bright);font-size:11px;">${t.task_name}</td>
                    <td style="font-size:10px;color:var(--text-muted);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${(t.command||'').replace(/"/g,'&quot;')}">${t.command || '—'}</td>
                    <td style="font-size:11px;">${t.run_as_user || '—'}</td>
                    <td style="font-size:11px;">${t.status || '—'}</td>
                    <td><span class="badge badge-blue" style="font-size:9px;">${t.source || '—'}</span></td>
                </tr>`).join('')}
                </tbody></table>
                </div>
            </div>`;
        }

        // Local Groups
        if (data.local_groups && data.local_groups.length > 0) {
            html += `<div class="panel" style="margin-bottom:16px;">
                <div style="padding:10px 14px;border-bottom:1px solid var(--border-primary);font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;">
                    Local Groups (${data.local_groups.length})
                </div>
                <div style="max-height:250px;overflow-y:auto;">
                <table class="data-table"><thead><tr><th>Group</th><th>Type</th><th>Members</th></tr></thead><tbody>
                ${data.local_groups.map(g => {
                    const members = JSON.parse(g.members || '[]');
                    const privBadge = g.is_privileged ? ' <span class="badge badge-red" style="font-size:8px;">PRIVILEGED</span>' : '';
                    return `<tr>
                        <td style="color:var(--text-bright);font-size:11px;">${g.group_name}${privBadge}</td>
                        <td style="font-size:11px;color:var(--text-muted);">${g.group_type || 'local'}</td>
                        <td style="font-size:10px;color:var(--text-secondary);">${members.length > 0 ? members.join(', ') : '<span style="color:var(--text-muted)">—</span>'}</td>
                    </tr>`;
                }).join('')}
                </tbody></table>
                </div>
            </div>`;
        }

        // Connections
        if (data.connections.length > 0) {
            html += `<div class="panel">
                <div style="padding:10px 14px;border-bottom:1px solid var(--border-primary);font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;">
                    Network Connections (${data.connections.length})
                </div>
                <table class="data-table"><thead><tr><th>Direction</th><th>Remote Host</th><th>Port</th><th>Protocol</th><th>Packets</th></tr></thead><tbody>
                ${data.connections.map(c => {
                    const isSource = c.src_host_id === h.id;
                    const remoteId = isSource ? c.dst_host_id : c.src_host_id;
                    const remoteIp = isSource ? (c.dst_ip || '?') : (c.src_ip || '?');
                    return `<tr>
                        <td>${isSource ? '<span style="color:var(--accent-cyan)">→ OUT</span>' : '<span style="color:var(--accent-amber)">← IN</span>'}</td>
                        <td style="color:var(--text-bright);">${remoteIp}</td>
                        <td>${c.dst_port || '—'}</td>
                        <td>${c.protocol || '—'}</td>
                        <td>${c.packet_count || 0}</td>
                    </tr>`;
                }).join('')}
                </tbody></table>
            </div>`;
        }

        document.getElementById('hostDetailBody').innerHTML = html;
        document.getElementById('hostDetailModal').style.display = 'flex';
    }

    function detailRow(label, value) {
        return `<div style="display:flex;justify-content:space-between;padding:3px 0;font-size:12px;">
            <span style="color:var(--text-muted);font-family:'JetBrains Mono',monospace;font-size:11px;">${label}</span>
            <span style="color:var(--text-primary);">${value || '<span style="color:var(--text-muted)">—</span>'}</span>
        </div>`;
    }

    function editableRow(label, field, value, hostId) {
        const escaped = value ? escapeHtml(value) : '';
        const display = escaped || '<span style="color:var(--text-muted)">—</span>';
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:12px;">
            <span style="color:var(--text-muted);font-family:'JetBrains Mono',monospace;font-size:11px;">${label}</span>
            <span class="editable-value" data-field="${field}" data-host-id="${hostId}"
                onclick="startEditField(this, '${field}', ${hostId})"
                style="color:var(--text-primary);cursor:pointer;padding:1px 6px;border-radius:3px;border:1px solid transparent;max-width:180px;text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"
                title="Click to edit"
                onmouseenter="this.style.borderColor='var(--border-hover)'"
                onmouseleave="this.style.borderColor='transparent'">${display}</span>
        </div>`;
    }

    function editableSelectRow(label, field, optionsHtml, hostId) {
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:12px;">
            <span style="color:var(--text-muted);font-family:'JetBrains Mono',monospace;font-size:11px;">${label}</span>
            <select class="editable-select" data-field="${field}" data-host-id="${hostId}"
                onchange="saveField('${field}', this.value, ${hostId})"
                style="background:var(--bg-primary);color:var(--text-primary);border:1px solid var(--border-primary);border-radius:3px;padding:1px 4px;font-size:11px;font-family:'JetBrains Mono',monospace;cursor:pointer;text-align:right;">
                ${optionsHtml}
            </select>
        </div>`;
    }

    function startEditField(el, field, hostId) {
        if (el.querySelector('input')) return;
        const currentVal = el.textContent === '—' ? '' : el.textContent.trim();
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentVal;
        input.style.cssText = 'background:var(--bg-primary);color:var(--text-bright);border:1px solid var(--accent-cyan);border-radius:3px;padding:2px 6px;font-size:11px;font-family:JetBrains Mono,monospace;width:100%;outline:none;';
        input.onkeydown = (e) => {
            if (e.key === 'Enter') { input.blur(); }
            if (e.key === 'Escape') { showHostDetail(hostId); }
        };
        input.onblur = () => {
            const newVal = input.value.trim();
            saveField(field, newVal, hostId);
            el.innerHTML = newVal ? escapeHtml(newVal) : '<span style="color:var(--text-muted)">—</span>';
            el.style.borderColor = 'transparent';
        };
        el.innerHTML = '';
        el.appendChild(input);
        el.style.borderColor = 'var(--accent-cyan)';
        input.focus();
        input.select();
    }

    async function saveField(field, value, hostId) {
        const body = {};
        body[field] = value || null;
        await fetch(`/api/hosts/${hostId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        });
        // Refresh host list to reflect changes
        await loadHosts();
    }

    async function saveHostNotes(hostId) {
        const area = document.getElementById('hostNotesArea');
        if (!area) return;
        await fetch(`/api/hosts/${hostId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({notes: area.value.trim() || null})
        });
    }

    function editServiceNote(cell, serviceId) {
        if (cell.querySelector('input')) return;
        const currentNote = cell.textContent.includes('add note') ? '' : cell.textContent.trim();
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentNote;
        input.placeholder = 'Enter note...';
        input.style.cssText = 'background:var(--bg-primary);color:var(--text-bright);border:1px solid var(--accent-cyan);border-radius:3px;padding:2px 6px;font-size:11px;font-family:JetBrains Mono,monospace;width:100%;outline:none;';
        input.onkeydown = (e) => {
            if (e.key === 'Enter') { input.blur(); }
            if (e.key === 'Escape') { showHostDetail(currentHostId); }
        };
        input.onblur = async () => {
            const note = input.value.trim();
            await fetch(`/api/services/${serviceId}/notes`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({notes: note})
            });
            cell.innerHTML = note ? escapeHtml(note) : '<span style="color:var(--text-muted);font-style:italic;font-size:10px;">+ add note</span>';
        };
        cell.innerHTML = '';
        cell.appendChild(input);
        input.focus();
        input.select();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ── Subnets ──
    async function loadSubnets() {
        allSubnets = await fetchJSON(`/api/missions/${MISSION_ID}/subnets`);
        const netColors = { IT:'var(--color-it)', OT:'var(--color-ot)', DMZ:'var(--color-dmz)', Management:'var(--color-mgmt)' };
        document.getElementById('tab-subnets').innerHTML = `
            <div class="panel"><table class="data-table"><thead><tr>
                <th>CIDR</th><th>Name</th><th>Type</th><th>VLAN</th><th>Gateway</th><th>Hosts</th><th>Discovery</th>
            </tr></thead><tbody>
            ${allSubnets.map(s => `<tr>
                <td style="color:var(--text-bright);font-weight:500;">${s.cidr}</td>
                <td>${s.name || '—'}</td>
                <td><span style="color:${netColors[s.network_type]||'var(--text-muted)'}">${s.network_type}</span></td>
                <td>${s.vlan_id || '—'}</td>
                <td>${s.gateway || '—'}</td>
                <td><span class="badge badge-blue">${s.host_count || 0}</span></td>
                <td style="font-size:11px;color:var(--text-muted);">${s.discovered_via}</td>
            </tr>`).join('')}
            </tbody></table></div>`;
    }

    // ── Connections ──
    async function loadConnections() {
        allConnections = await fetchJSON(`/api/missions/${MISSION_ID}/connections`);
        document.getElementById('tab-connections').innerHTML = `
            <div class="panel"><table class="data-table"><thead><tr>
                <th>Source</th><th>Destination</th><th>Port</th><th>Protocol</th><th>Packets</th><th>Bytes</th>
            </tr></thead><tbody>
            ${allConnections.map(c => {
                const srcLabel = c.src_hostname ? `${c.src_hostname} (${c.src_ip_resolved})` : c.src_ip_resolved || '?';
                const dstLabel = c.dst_hostname ? `${c.dst_hostname} (${c.dst_ip_resolved})` : c.dst_ip_resolved || '?';
                const total = (c.bytes_sent||0) + (c.bytes_recv||0);
                return `<tr>
                    <td style="color:var(--text-bright);">${srcLabel}</td>
                    <td style="color:var(--text-bright);">${dstLabel}</td>
                    <td style="color:var(--accent-cyan);">${c.dst_port || '—'}</td>
                    <td>${c.protocol || '—'}</td>
                    <td>${(c.packet_count||0).toLocaleString()}</td>
                    <td style="font-size:11px;">${formatBytes(total)}</td>
                </tr>`;
            }).join('')}
            </tbody></table></div>`;
    }

    // ── Threat Intel ──
    async function loadIntel() {
        const intel = await fetchJSON(`/api/missions/${MISSION_ID}/threat_intel`);
        if (intel.length === 0) {
            document.getElementById('tab-intel').innerHTML = '<div class="empty-state" style="padding:40px;">No threat intelligence imported for this mission.</div>';
            return;
        }
        document.getElementById('tab-intel').innerHTML = intel.map(i => {
            const ttps = JSON.parse(i.ttps || '[]');
            const iocs = JSON.parse(i.iocs || '[]');
            return `<div class="panel" style="margin-bottom:16px;">
                <div class="panel-header">
                    <div class="panel-title" style="color:var(--accent-red);">${i.threat_actor || 'Unknown Actor'}</div>
                    <div style="font-size:11px;color:var(--text-muted);">${i.source || ''}</div>
                </div>
                <div class="panel-body">
                    <p style="color:var(--text-secondary);font-size:13px;line-height:1.6;margin-bottom:16px;">${i.description || ''}</p>
                    ${ttps.length ? `<div style="margin-bottom:12px;">
                        <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">MITRE ATT&CK TTPs</div>
                        <div style="display:flex;gap:6px;flex-wrap:wrap;">
                            ${ttps.map(t => `<span class="badge badge-red">${t}</span>`).join('')}
                        </div>
                    </div>` : ''}
                    ${iocs.length ? `<div>
                        <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Indicators of Compromise</div>
                        <div style="display:flex;gap:6px;flex-wrap:wrap;">
                            ${iocs.map(ioc => `<code style="background:var(--bg-primary);padding:3px 8px;border-radius:4px;font-size:11px;color:var(--accent-amber);border:1px solid var(--border-primary);">${ioc}</code>`).join('')}
                        </div>
                    </div>` : ''}
                </div>
            </div>`;
        }).join('');
    }

    // ── Hunt Hypotheses ──
    async function loadHypotheses() {
        const hyps = await fetchJSON(`/api/missions/${MISSION_ID}/hypotheses`);
        if (hyps.length === 0) {
            document.getElementById('tab-hypotheses').innerHTML = '<div class="empty-state" style="padding:40px;">No hunt hypotheses generated yet.</div>';
            return;
        }
        const prioColors = { critical:'var(--crit-critical)', high:'var(--crit-high)', medium:'var(--crit-medium)', low:'var(--crit-low)' };
        document.getElementById('tab-hypotheses').innerHTML = hyps.map(h => `
            <div class="panel" style="margin-bottom:12px;border-left:3px solid ${prioColors[h.priority]||'var(--border-primary)'};">
                <div style="padding:14px 18px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span class="crit-badge crit-${h.priority}">${h.priority}</span>
                            <span style="font-weight:600;font-size:14px;">${h.title}</span>
                        </div>
                        ${h.mitre_technique ? `<span class="badge badge-red">${h.mitre_technique}</span>` : ''}
                    </div>
                    <p style="color:var(--text-secondary);font-size:13px;line-height:1.5;">${h.description || ''}</p>
                    <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
                        <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;">Status:</span>
                        <span class="badge badge-${h.status==='confirmed'?'red':h.status==='investigating'?'amber':'blue'}">${h.status}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // ── Export ──
    async function exportMission() {
        const data = await fetchJSON(`/api/missions/${MISSION_ID}/export`);
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `mission_${MISSION_ID}_export.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // ── Helpers ──
    async function fetchJSON(url) {
        const res = await fetch(url);
        return res.json();
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // ── Add Host ──
    function showAddHostModal() {
        document.getElementById('newHostIp').value = '';
        document.getElementById('newHostHostname').value = '';
        document.getElementById('newHostDomain').value = '';
        document.getElementById('newHostType').value = 'unknown';
        document.getElementById('newHostCrit').value = 'medium';
        document.getElementById('newHostOs').value = '';
        document.getElementById('newHostVendor').value = '';
        document.getElementById('newHostNotes').value = '';
        document.getElementById('addHostModal').style.display = 'flex';
    }

    async function createHost() {
        const ip = document.getElementById('newHostIp').value.trim();
        if (!ip) return alert('IP address is required');
        const data = {
            ip_address: ip,
            hostname: document.getElementById('newHostHostname').value.trim() || null,
            domain: document.getElementById('newHostDomain').value.trim() || null,
            device_type: document.getElementById('newHostType').value,
            criticality: document.getElementById('newHostCrit').value,
            os_name: document.getElementById('newHostOs').value.trim() || null,
            device_vendor: document.getElementById('newHostVendor').value.trim() || null,
            notes: document.getElementById('newHostNotes').value.trim() || null,
            discovered_via: 'manual'
        };
        const res = await fetch(`/api/missions/${MISSION_ID}/hosts`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        if (res.ok) {
            closeModal('addHostModal');
            await loadHosts();
            await loadStats();
        } else {
            alert('Failed to add host');
        }
    }

    // ── Add Service ──
    let addServiceHostId = null;

    function showAddServiceModal(hostId) {
        addServiceHostId = hostId;
        document.getElementById('addServiceTitle').textContent = `Add Service to Host`;
        document.getElementById('newSvcPort').value = '';
        document.getElementById('newSvcProto').value = 'tcp';
        document.getElementById('newSvcName').value = '';
        document.getElementById('newSvcVersion').value = '';
        document.getElementById('newSvcNotes').value = '';
        document.getElementById('addServiceModal').style.display = 'flex';
    }

    async function createService() {
        const port = parseInt(document.getElementById('newSvcPort').value);
        if (!port || port < 1 || port > 65535) return alert('Valid port number is required (1-65535)');
        const data = {
            port: port,
            protocol: document.getElementById('newSvcProto').value,
            service_name: document.getElementById('newSvcName').value.trim() || null,
            service_version: document.getElementById('newSvcVersion').value.trim() || null,
            notes: document.getElementById('newSvcNotes').value.trim() || null,
            state: 'open'
        };
        const res = await fetch(`/api/hosts/${addServiceHostId}/services`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        if (res.ok) {
            closeModal('addServiceModal');
            await showHostDetail(addServiceHostId);
            await loadHosts();
        } else {
            alert('Failed to add service');
        }
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // Close modal on overlay click
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) e.target.style.display = 'none';
    });

    init();
    </script>
</body>
</html>
